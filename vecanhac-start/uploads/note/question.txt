
bussiness rule kiá»ƒu j cx cÃ³ dáº¡ng lock ticket khi khÃ¡ch hÃ ng thanh toÃ¡n
Ä‘Ãºng ko ? Liá»‡t kÃª ra mÃ¬nh lock kiá»ƒu j lock dÆ°á»›i db hay Ä‘á»•i status
 sau bao nhiÃªu giÃ¢y thÃ¬ scan náº¿u ko thanh toÃ¡n thÃ¬ release ticket Ä‘i ?
 Rá»“i Ä‘áº¿n search redis liá»‡t kÃª ra caching pattern Ä‘Ã£ sá»­ dá»¥ng vd thÃªm 1
 ticket má»›i thÃ¬ search cÃ³ ra ko? Send email váº­y thÃ¬ cÃ³ dÃ¹ng async ko hay
 pháº£i Ä‘á»£i bÃªn kia response láº¡i, etc...

 ğŸ” 1. Lock ticket khi user thanh toÃ¡n
 â“ VÃ¬ sao cáº§n lock?
 TrÃ¡nh oversell (bÃ¡n nhiá»u hÆ¡n sá»‘ lÆ°á»£ng vÃ© thá»±c táº¿)

 TrÃ¡nh race condition khi nhiá»u ngÆ°á»i cÃ¹ng chá»n 1 vÃ©

 Báº£o vá»‡ tráº£i nghiá»‡m: khi user click thanh toÃ¡n, Ä‘áº£m báº£o há» khÃ´ng bá»‹ â€œháº¿t vÃ©â€ giá»¯a chá»«ng

 âœ… CÃ¡c phÆ°Æ¡ng phÃ¡p lock vÃ©
 PhÆ°Æ¡ng phÃ¡p	MÃ´ táº£	Æ¯u Ä‘iá»ƒm	NhÆ°á»£c Ä‘iá»ƒm
 1. Lock báº±ng DB (táº¡m thá»i giáº£m quantity_sold)	Ngay khi táº¡o order, cá»™ng quantity_sold vÃ  lÆ°u order.status = PENDING	ÄÆ¡n giáº£n, dá»… triá»ƒn khai	Cáº§n scheduler Ä‘á»ƒ release vÃ© sau timeout
 2. Lock báº±ng status (VD: ticket.status = HOLD)	Gáº¯n tráº¡ng thÃ¡i HOLD vÃ o vÃ©, hoáº·c táº¡o báº£ng ticket_holds Ä‘á»ƒ track táº¡m thá»i	RÃµ rÃ ng, tÃ¡ch biá»‡t business logic	Cáº§n batch cleanup + dá»… conflict náº¿u nhiá»u ngÆ°á»i giá»¯ 1 loáº¡i vÃ©
 3. Lock báº±ng Redis	DÃ¹ng Redis lock hoáº·c TTL (setex key:ticket_id userId 15m) Ä‘á»ƒ giá»¯ quyá»n Ä‘áº·t vÃ©	Nhanh, Ã­t áº£nh hÆ°á»Ÿng DB	Cáº§n Ä‘á»“ng bá»™ khi Redis máº¥t káº¿t ná»‘i
 4. Lock báº±ng order_items táº¡m thá»i	Táº¡o order_items vá»›i order.status = PENDING, táº¡m giá»¯ vÃ© theo sá»‘ lÆ°á»£ng	Gáº§n giá»‘ng phÆ°Æ¡ng Ã¡n 1 nhÆ°ng dá»… tracking	Cáº§n xá»­ lÃ½ rollback náº¿u huá»·

ğŸ¯ Tá»•ng káº¿t Redis Lock Flow
pgsql
Copy
Edit
[User chá»n vÃ©]
   â¬‡ï¸
[POST /checkout]
   â¬‡ï¸
Redis SET key: lock:ticket:{id}:user:{uid} EX 900 NX
   â¬‡ï¸
Táº¡o order status = PENDING
   â¬‡ï¸
Redirect Ä‘áº¿n VNPAY
   â¬‡ï¸
Webhook tráº£ vá» â†’ kiá»ƒm tra Redis key cÃ²n khÃ´ng?
   â¬‡ï¸
Náº¿u CÃ“: SUCCESS + cáº­p nháº­t DB + del key
Náº¿u KHÃ”NG: CANCEL Ä‘Æ¡n

 ğŸ” Sau 15 phÃºt, náº¿u user khÃ´ng thanh toÃ¡n:

 Update order.status = CANCELLED

 Tráº£ láº¡i vÃ©: tickets.quantity_sold -= x

 (Redis: xoÃ¡ key hold hoáº·c unlock)

 ğŸ§  2. Scan/check Ä‘Æ¡n chÆ°a thanh toÃ¡n â€“ khi nÃ o thÃ¬ release vÃ©
 DÃ¹ng ScheduledJob (Spring @Scheduled) hoáº·c cron job 5 phÃºt/láº§n:

 sql
 Copy
 Edit
 UPDATE orders
 SET status = 'CANCELLED'
 WHERE status = 'PENDING'
   AND created_at < NOW() - INTERVAL 15 MINUTE;
 TÃ¹y logic vÃ© giá»¯ á»Ÿ Ä‘Ã¢u, rollback láº¡i:

 quantity_sold

 ticket_hold table

 Redis key

 âš¡ 3. Caching Pattern khi search tickets/events
 â“ Khi search, dá»¯ liá»‡u cache tá»« Ä‘Ã¢u? Khi nÃ o invalidate?
 TÃ¬nh huá»‘ng	Caching Pattern	Ghi chÃº
 Search sá»± kiá»‡n theo tá»« khÃ³a	ğŸ” Read-through cache	FE gá»i /search?query=roinÆ°á»›c â†’ tÃ¬m trong Redis, khÃ´ng cÃ³ thÃ¬ láº¥y tá»« DB rá»“i cache
 Load homepage	ğŸ”ƒ Write-through (cache khi táº¡o má»›i)	Khi táº¡o event má»›i â†’ update cáº£ Redis + DB
 Chi tiáº¿t sá»± kiá»‡n (event detail)	âš¡ Cache-aside	FE gá»i /events/:slug, cache 15 phÃºt
 Danh sÃ¡ch vÃ© cá»§a 1 sá»± kiá»‡n/showing	âš¡ Cache-aside hoáº·c preload theo showingId

 âŒ Náº¿u thÃªm vÃ© má»›i mÃ  khÃ´ng update láº¡i Redis â†’ search khÃ´ng tháº¥y.
 âœ… Pháº£i invalidate cache hoáº·c dÃ¹ng cache layer cÃ³ TTL (Time To Live) Ä‘á»ƒ refresh.

 ğŸ“§ 4. Send Email â€“ CÃ³ cáº§n async khÃ´ng?
 CÃ¡ch lÃ m	Æ¯u Ä‘iá»ƒm	NhÆ°á»£c Ä‘iá»ƒm
 Gá»­i trá»±c tiáº¿p khi táº¡o order	Dá»… lÃ m	Blocking â†’ cháº­m API â†’ dá»… timeout
 âœ… Gá»­i async qua Queue (RabbitMQ, Kafka, hoáº·c @Async)	KhÃ´ng cháº·n thread
 Dá»… retry
 Quáº£n lÃ½ tháº¥t báº¡i tá»‘t	Cáº§n setup thÃªm queue hoáº·c thread pool

 Gá»£i Ã½ dÃ¹ng Spring Boot:
 Gá»­i email qua @Async hoáº·c RabbitMQ:

 java
 Copy
 Edit
 @Async
 public void sendTicketEmail(Order order) {
    emailService.send(order.getUserEmail(), buildHtmlTicket(order));
 }
 Hoáº·c producer gá»­i EmailJob vÃ o queue â†’ cÃ³ 1 email-consumer xá»­ lÃ½ riÃªng

 ğŸ“¦ TÃ³m táº¯t chuáº©n hÃ³a production-flow cho checkout + ticketing
 BÆ°á»›c	Thao tÃ¡c	CÃ´ng nghá»‡
 1ï¸âƒ£ User chá»n vÃ©	LÆ°u táº¡m vÃ o local hoáº·c session	FE
 2ï¸âƒ£ Submit thanh toÃ¡n	Táº¡o order + order_items, quantity_sold++, status = PENDING	DB + Lock
 3ï¸âƒ£ Redirect thanh toÃ¡n (VNPAY)	â€”	FE
 4ï¸âƒ£ Webhook/callback hoáº·c redirect	Update order.status = PAID/SUCCESS	Backend
 5ï¸âƒ£ Scheduler má»—i 5 phÃºt	Huá»· Ä‘Æ¡n PENDING quÃ¡ 15 phÃºt â†’ quantity_sold--	Cron + SQL
 6ï¸âƒ£ Gá»­i email	Gá»­i async qua queue hoáº·c thread	@Async / Kafka / RabbitMQ
 7ï¸âƒ£ Cache search & homepage	Cache-aside / read-through	Redis, TTL, Invalidate khi táº¡o má»›i